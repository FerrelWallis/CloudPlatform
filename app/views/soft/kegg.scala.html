@()(implicit session: Session)
@home.main("KEGG"){

    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("css/test/mysoft.css")" media="screen" />
        <!--button弹出操作-->
    <script src="@routes.Assets.versioned("layer-v3.0/layer/layer.js")" type="text/javascript"></script>
    <script type="text/javascript" src="@routes.Assets.versioned("js/myzui.min.js")"></script>

    <style>
            .checkbox-primary > label:after, .checkbox-primary > input, .radio-primary > label:after, .radio-primary > input {
                color: #ffffff00;
                margin: 0;
                top: 7px;
                left: -2px;
                width: 13px;
                height: 13px;
            }
            .mysoft-content-left .form-group-extra .btn-sm {
                font-size: 14px;
                background-color: #27b9d0;
                border-color: #27b9d0;
                border-radius: 4px;
                padding: 5px 15px;
                height: auto;
            }
            .mysoft-content-right .tab-content, .mysoft-content-left form {
                box-shadow: unset;
            }
            .img-thumbnail {
                display: inline-block;
                max-width: 100%;
                height: auto;
                padding: 4px;
                line-height: 1.53846154;
                background-color: #fff;
                border: unset;
                border-radius: 4px;
                -webkit-transition: all .2s ease-in-out;
                -o-transition: all .2s ease-in-out;
                transition: all .2s ease-in-out;
            }
            blockquote {
                padding: 10px 20px;
                margin: 0 0 20px;
                border-left: unset;
            }
    </style>

    <div class="col-md-12 mysoft-content">
        <div class=" whitebox mysoft-content-left" style="width: 720px;">
            <form id="KEGG" method="GET" enctype="multipart/form-data" class="well form-inline" style="box-sizing: border-box!important;">
                <img class="tools-img" src="/assets/images/softpic/pathwaygsea.png">
                <h3 class="tools-title">
                    KEGG富集分析&nbsp;&nbsp;&nbsp;&nbsp;
                </h3>
                <div class="form-group">
                    <h2>
                    </h2>
                </div><br><br>
                <div class="form-group-p">
                    <div class="form-group">
                        <label for="mytaskname">任务编号：</label>
                    </div>
                    <div class="form-group">
                        <input id="mytaskname" type="text" class="form-control" name="taskname" placeholder="" value="pathwaygseabb848a">
                    </div>
                </div>

                <br><br>

                <script type="text/javascript">
                        $("#mytaskname").keyup(function () {
                            var val = $("#mytaskname").val();
                            var rule = /[()（）@@#$%^&*~`!|\/\\?;,.，。:"]/;
                            if (rule.test(val)) {
                                alert('任务编号里不能有特殊字符，请重新填写!');
                            }
                        })
                </script>
                <em>1：</em><label for="exampleInputName2">
                <span class="pointer" data-toggle="collapse" href="#collapseOne">富集目的基因列表文件：</span>
            </label>
                <ul class="nav nav-tabs">
                    <li class="active"><a href="###" data-target="#tab2Content3" data-toggle="tab">输入文件</a>
                    </li>
                    <li><a href="###" data-target="#tab2Content4" data-toggle="tab">手动输入</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade active in" id="tab2Content3">
                        <br>
                        <div id="div1" class="one-line">

                            <div class="form-group-p">

                                <div class="form-group">
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-control" id="filepath1" name="text1" readonly="readonly">
                                    <img id="tempimg1" dynsrc="" src="" style="display:none">
                                    <input id="hideinput1" type="file" name="table1" style="display:none;" onchange="change(this.value)">
                                </div>
                            </div>
                            <div class="form-group-extra">

                                <span id="choosefile" type="button" onclick="choosefile($(this))" data-id="1" class="btn btn-sm btn-info choosebutton">选择文件</span>
                                <em>
                                    <a href="/tools/Public/help/example.gene" target="_blank">
                                        示例文件                                            </a>
                                </em>
                            </div>

                            <br><br>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tab2Content4">
                        <p><br>
                        </p><p><textarea id="" name="txdata" class="form-control kindeditorSimple" style="height:150px;width:100%;" placeholder="或手动输入文件"></textarea></p>
                        <p></p>
                    </div>
                </div>
                <br>

                <div class="form-group">
                    <em>2：</em><label for="exampleInputName2">
                    <input type="checkbox" name="userefer" value="A" id="userefer">&nbsp;&nbsp;
                    <span class="pointer" data-toggle="collapse" href="#collapse2">
                        使用已有参考                                </span>
                </label>
                </div>
                <br><br>
                <div id="para" style="display:none;">
                    <label for="exampleInputName2">
                        <span>物种/类型/版本</span>
                    </label>
                    <div class="form-group" style="display: block;">
                        <select name="para22" id="para22">
                            <option value="osa" selected="selected">Oryza sativa Japonica genes (IRGSP-1.0
                                (IRGSP-1.0))
                            </option>
                            <option value="ath">Arabidopsis thaliana genes (TAIR10 (2010-09-TAIR10))</option>
                            <option value="mmu">Mus musculus genes (GRCm38.p4)</option>
                            <option value="rno">Rattus norvegicus genes (Rnor_6.0)</option>
                            <option value="dre">Danio rerio genes (GRCz10)</option>
                            <option value="gga">Gallus gallus genes (Galgal4) E</option>
                            <option value="hsa">Homo sapiens genes (GRCh38.p5)</option>
                            <option value="cel">Caenorhabditis elegans genes (WBcel235 (WS250))</option>
                            <option value="dme">Drosophila melanogaster genes (BDGP6 (dmel_r6.02_FB2014_05)
                            </option>
                        </select>
                        <select name="para33" id="para33">
                            <option value="gene" selected="selected">基因</option>
                            <option value="ts">转录本</option>
                        </select>
                        <select name="para44" id="para44">
                            <option value="1" selected="selected">Ensemble_96 or 43</option>
                        </select>
                    </div >
                    <br><br>
                    <span id="preview" type="button" onclick="preview()" class="btn btn-sm btn-info ">预览参考文件</span>
                </div>

                <br> <br>
                <div id="collapse2" class="panel-collapse fade collapse" style="height: auto;">
                    <div class="panel-body">
                        目前提供的物种有水稻、拟南芥、小鼠、大鼠、斑马鱼、鸡、秀丽线虫、果蝇、人。ID类型可选择基因ID或转录本ID，根据富集目的基因的ID类型决定。可以点击“使用已有参考选项”后出现的“预览参考文件”来查看具体ID。                            </div>
                </div>
                <script type="text/javascript">
                        var A = 'A={"rsa":"rsa--Oryza sativa Japonica genes (IRGSP-1.0 (IRGSP-1.0))\n","ath":"ath--Arabidopsis thaliana genes (TAIR10 (2010-09-TAIR10))\n","mmu":"mmu--Mus musculus genes (GRCm38.p4)\n","rno":"rno--Rattus norvegicus genes (Rnor_6.0)\n","dre":"dre--Danio rerio genes (GRCz10)\n","gga":"gga--Gallus gallus genes (Galgal4)\n","hsa":"hsa--Homo sapiens genes (GRCh38.p5)\n","cel":"cel--Caenorhabditis elegans genes (WBcel235 (WS250))\n","dme":"dme--Drosophila melanogaster genes (BDGP6 (dmel_r6.02_FB2014_05))\n"}';
                        var json = eval(A);
                        var str = '';
                        for (var key in json) {
                            str = str + '<option value=' + key + '>' + json[key] + '</option>';
                        }
                        $("#para22").html(str);

                        function preview() {
                            // $para=$(this).parent().attr("id");
                            var para1 = $("#para44").val();
                            var para2 = $("#para33").val();
                            var para3 = $("#para22").val();

                            $.post("/tools/home/soft/pathwayannotpreview", {
                                para1: para1,
                                para2: para2,
                                para3: para3
                            }, function (data) {
                                data = $.parseJSON(data);

                                (new $.zui.ModalTrigger({
                                    custom: function () {
                                        str = '<div style="overflow:auto;width:880px;height:500px;white-space:nowrap;">' + data.type + '</div>';

                                        return str;
                                    }, width: '900px', height: '600px', icon: 'file', title: ''
                                })).show();

                            })
                        }
                </script>

                <div id="nouserefer">
                    <div id="collapseOne" class="panel-collapse fade collapse" style="height: auto;">
                        <div class="panel-body">
                            即想要研究的基因列表，每行第一列为基因id，要包含在背景基因表中.                                </div>
                    </div>

                    <div id="div2" class="one-line">
                        <div class="form-group-p">

                            <div class="form-group">
                                <em>3：</em><label for="exampleInputName2">
                                <span class="pointer" data-toggle="collapse" href="#collapseTwo">背景基因表：</span>
                            </label>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" style="" id="filepath2" name="text2" readonly="readonly">
                                <img id="tempimg2" dynsrc="" src="" style="display:none">
                                <input id="hideinput2" type="file" name="table2" style="display:none;" onchange="change(this.value)">
                            </div>

                        </div>
                        <div class="form-group-extra">

                            <span id="choosefile" type="button" onclick="choosefile($(this))" data-id="2" class="btn btn-sm btn-info choosebutton">选择文件</span>

                            <em>
                                <a href="/tools/Public/help/example.txt" target="_blank">
                                    示例文件                                        </a>
                            </em>
                            <div id="collapseTwo" class="panel-collapse fade collapse" style="height: auto;">
                                <div class="panel-body">
                                    即所有基因的列表，第一列为基因id，第二列为用于获取pathway的一个id，有3种类型kegid、ncbi-geneid、KO号（具体可以点击案例演示查看）                                    </div>
                            </div>
                        </div>

                        <br><br>

                    </div>

                    <div class="one-line">

                        <div class="form-group-p">

                            <div class="form-group">
                                <em>4：</em><label for="format">背景基因表类型：</label>
                            </div>
                            <div class="form-group">
                                <select name="parameter4" id="parameter4">
                                    <option value="1" selected="selected"> KO</option>
                                    <option value="2">ncbi-geneid</option>
                                    <option value="5">keggid</option>
                                    <option value="6">kopath</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group-extra">

                            <span class="must">*</span>
                            <span style="font-size:smaller"><em>注意此类型选择要与上一项基因表对应</em></span>
                        </div>
                        <br><br>
                    </div>


                    <div>
                        <div class="form-group-p">

                            <div class="form-group">
                                <em>5：</em><label for="format">物种类型：</label>
                            </div>
                            <div class="form-group">
                                <select name="parameter3" id="parameter3">
                                    <option value="1"> 动物</option>
                                    <option value="2">植物</option>
                                    <option value="3">微生物</option>
                                    <option value="4">真菌</option>
                                    <option value="5" selected="selected">全库</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group-extra">

                            <span class="must">*</span>
                        </div>
                        <br><br>
                    </div>
                </div>

                <div class="form-group-p">
                    <div class="form-group">

                        <input type="checkbox" name="desc" value="A" id="adddesc">
                        添加基因差异表达差异倍数                            </div>
                    <div id="div3" class="form-group" style="display: none;padding-left: 10px;">
                        <input type="text" class="form-control input-sm" style="" id="filepath3" name="text3" readonly="readonly">
                        <img id="tempimg3" dynsrc="" src="" style="display:none">
                        <input id="hideinput3" type="file" name="table3" style="display:none;" onchange="change(this.value)">
                    </div>
                </div>
                <div id="div4" class="form-group-extra" style="display: none;">
                    <span id="choosefile" type="button" onclick="choosefile($(this))" data-id="3" class="btn btn-sm btn-info choosebutton">选择文件</span>
                    <a href="/tools/Public/help/pathwayrpkm.txt" target="_blank" style=" margin-left:10px; ">
                        <em>示例文件 &gt;</em>
                    </a>
                </div>
                <br>
                <br>

                <br style="clear:both;">
                <br style="clear:both;">
                <input type="hidden" value="upload" name="act">
                <input type="hidden" value="blastcmp" name="action">
                <input type="button" value="提&nbsp;&nbsp;交" name="submit" class="btn btn-primary" onclick="kegg()">
            </form>

        </div>

        <div class="handler"></div>
        <div class="mysoft-content-right" style="width: 330px;">

            <ul class="nav nav-tabs nav-tabs-right">
                <li class="active">
                    <a href="###" data-target="#tab2Content2" data-toggle="tab">示例结果</a>
                </li>
                <li class="">
                    <a href="###" data-target="#tab2Content1" data-toggle="tab">使用说明</a>
                </li>
            </ul>
            <div class="tab-content" style="box-sizing: border-box!important;">
                <div class="tab-pane fade active in" id="tab2Content2">
                    <h5>输出结果：分两个部分，上面为pathway的富集信息（图1），包括pathway名，基因数，背景基因数，P值，Q值，pathwayID，下面为每个pathway具体的基因（图2），点击pathway名可以查看基因在pathway的信息（图3）：</h5>

                    <br>图1: the page layout of out.html
                    <img class="img-rounded img-thumbnail img-responsive" src="/assets/images/softpic/exampleResult/path1.png" alt="生物云平台"> <br>
                    <br>图2: kegg map of out_map
                    <!-- <img class="img-rounded img-thumbnail img-responsive" src="/tools/Public/help/path2.png" alt="生物云平台"> -->
                    <img class="img-rounded img-thumbnail img-responsive" src="/assets/images/softpic/exampleResult/path3.png" alt="生物云平台"> <br>

                    <br>图3：pathway classification of out.path.png

                    <!-- <p>② out_map: 基因在各个pathway的位置图。</p>
                            <p>③out.path.xls：pathway的富集统计表，与out.htm一致，包含：KEGGA级分类，B级分类，pathway名，基因数，背景基因数，P值，Q值，pathwayID，基因id。</p>
                            <p>④out_path.png，out_path.svg：KEGGB级分类基因数量结果统计图.</p> -->
                    <img class="img-rounded img-thumbnail img-responsive" src="/assets/images/softpic/exampleResult/path4.png" alt="生物云平台">
                </div>
                <div class="tab-pane fade" id="tab2Content1">
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span><a href="" target="_blank"><i class="icon icon-question-sign" style="font-size: 14px!important;"></i><strong><span style="color:#337FE5;">了解该工具的原理与详细解析，请点击＞＞</span></strong></a></span>
                    </p>
                    <p>
                        <b><br>
                        </b>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">功能：</span><br>
                        在生物体内，不同基因相互协调行使其生物学功能，基于Pathway的分析有助于更进一步了解基因的生物学功能。KEGG是有关Pathway的主要公共数据库。 Pathway显著性富集分析以KEGG Pathway为单位，应用超几何检验，找出与整个基因组背景相比，在差异表达基因中显著性富集的Pathway。<br>
                        P的计算公式<img src="/assets/images/softpic/exampleResult/20191114110412_36169.png" alt="" width="180" height="100" title="" align="">其中，N为所有基因（背景基因）的数量，n为差异基因（目的基因）的数量，M为所有基因中该pathway的数量，i为差异基因中注释到该pathway的数量，计算得到的pvalue通过FDR校正之后，以corrected-pvalue≤0.05为阈值，满足此条件的pathway定义为在差异表达基因中显著富集的pathway。
                    </p>
                    <br>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">输入：</span>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ①输入的表格文件，必须为txt格式。可以选择在excel中将数据打开，然后另存为"文本文件(制表符分隔)(*.txt)"。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ②富集的目的基因列表，即想要研究的基因列表，每行第一列为基因id，要包含在背景基因表中.注意此文件不用加行名。<span style="color:red;">注意此文件第一行不是文字说明的行名，直接就是具体的基因ID号,请查看例子文件格式。</span>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ③背景基因总表，即所有基因的列表，第一列为基因id，第二列为用于获取pathway的一个id，有3种类型：<br>
                        类型1：kegid，例如mmu:18053，即KEGG官网上的id，可以通过KEGG注释或者KEGG官网获得。<br>
                        类型2：ncbi-geneid，例如18053，即ncbi上得到的geneid，一连串数字组成。<br>
                        类型3：KO号，例如K10942，不同物种间相同KO号会有对应不同的pathway的情况，详情可以查看KEGG官网，直接通过KO号获取pathway会不准确。建议通过前两种类型来获取。<br>
                        类型4：类型4，kopath，为本公司提供的类型文件，第一列为基因id，第二列为KO号，第三列为通路编号，以“，”分隔，第4列为kegid。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ④基因差异表达差异倍数表：第一列为基因ID，第二列为差异表达倍数log2(FC)。
                    </p>
                    <br>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">参数：</span>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ①背景基因表类型有3种，分别为：KO，ncbi-geneid、KEGGid。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ②数据库:当背景基因表类型为keggid和ncbi-geneid时，选择相应物种库和全库都可以，但选择相应物种库能缩短运行时间；当背景基因表类型为KO类型时，建议选择相应物种库进行注释。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ③可选参数：添加基因差异表达差异倍数表。
                    </p>
                    <br>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">输出：</span>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ①out.path.xls : 目的基因相对于背景基因的富集统计表。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ②out_map： 目的基因在各个pathway map的结果图。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ③out.path.png，out.path.svg：各个pathway的B级分类的统计图。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ④out.htm： 网页格式结果<span style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">。</span>
                    </p>                        </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="@routes.Assets.versioned("js/toolsAdjust.js")"></script>
    <script type="text/javascript">

        var userefer=false;
        var desc=false;

        function kegg() {

            if($("#userefer").is(':checked')) userefer=true;

            if($("#adddesc").is(':checked')) desc=true;

            if(@session.get("userId").isEmpty){
                swal({
                    title: "尚未登录",
                    text: "请先登录账号",
                    type: "warning",
                    confirmButtonText: "确认"
                })
            }else {

                var form1 = new FormData($("#KEGG")[0]);
                var element = "<div id='content'><span id='info'>运行中...</span>&nbsp;<img class='runningImage' src='/assets/images/loader-twitter.gif' style='width: 30px;height: 20px;'></div>"
                var index = layer.alert(element, {
                    skin: 'layui-layer-lan',
                    closeBtn: 0,
                    title: "Info",
                    btn: []
                });

                $.ajax({
                    url: "/CloudPlatform/SoftTool/runKegg?id=@session.get("userId")"+"&userefer="+userefer+"&desc="+desc,
                    type: "post",
                    processData: false,
                    contentType: false,
                    data: form1,
                    success: function (data) {
                        if (data.valid === "false") {
                            layer.close(index);
                            swal("Error", data.message, "error");

                        } else {

                            layer.close(index);
                            $.ajax({
                                url:"/CloudPlatform/SoftTool/getFiles?id=@session.get("userId")"+"&taskname="+data.taskname,
                                type:"post",
                                success:function (pics) {
                                    var pic = "";
                                    var html = "";
                                    $.each(pics,function (i,v) {
                                        pic +="<li><img class='img-rounded img-thumbnail img-responsive' src='/CloudPlatform/pic?path="+v+"' alt=\"生物云平台\"><li>"
                                        html += "<li><a href='/CloudPlatform/SoftTool/download?path="+data.path+"&name=" + v.substring(v.lastIndexOf("\\")+1,v.length) + "' target='_blank'>" + v.substring(v.lastIndexOf("\\")+1,v.length) + "</a></li>"
                                    });
                                    $("#filesUrl").html(html);
                                    $("#pics").html(pic);
                                }
                            })

                            $("#result_tab1").show();
                            $("#result_tab1").addClass("active")
                            $("#out_tab1").removeClass("active")
                            $("#ins_tab1").removeClass("active")
                            $("#result1").addClass("active").addClass("in")
                            $("#form1").removeClass("active");
                            $("#instruction1").removeClass("active");
                        }
                    }
                });
            }
        }

        function choosefile($para) {
            if(@session.get("userId").isEmpty){
                swal({
                    title: "尚未登录",
                    text: "请先登录账号",
                    type: "warning",
                    confirmButtonText: "确认"
                })
            }else {
                $number = $para.attr("data-id");
                $("#hideinput" + $number).click();
            }
        }

            //上传文件判断，大小和格式 限制! 问题：云端文件判断不了。（云端文件上传时已经经过限制，可以大于5M，本地限制大小是因上传速度问题)
            var maxsize = 5 * 1024 * 1024;//2M
            var errMsg = '建议使用云端文件，本地文件上传最大为5M！';

        function change(value, rowMax, colMax) {
            $("#filepath" + $number).val(value);
            var filepath = document.getElementById("hideinput" + $number);

            var file_size = 0;


            file_size = filepath.files[0].size;
            let name = filepath.files[0].name;
            let patt = /^[a-zA-Z0-9._]+$/;
            if (!patt.test(name)) {
                alert("文件名只能由字母，数字，'_'和'.'组成");
                $("#filepath" + $number).val('');
                $("#hideinput" + $number).val('');
            }
            var size = file_size;
            if (size > maxsize) {
                alert(errMsg);
                $("#filepath" + $number).val('');
                $("#hideinput" + $number).val('');
            }

        }

            $(document).ready(function () {
                $("#userefer").on("click", function () {
                    $("#para").toggle();
                    var isSelected = this.checked;
                    if (isSelected == true) {
                        $("#nouserefer").hide();
                    } else {
                        $("#nouserefer").show();
                    }
                })
                $("#adddesc").click(function () {
                    $("#div3").toggle();
                    $("#div4").toggle();
                })
            });
    </script>

}