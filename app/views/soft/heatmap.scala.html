@()(implicit session: Session)
@home.main("PCA"){

    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("css/test/mysoft.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("palette/evol-colorpicker.min.css")" media="screen" />

        <!--button弹出操作-->
    <script type="text/javascript" src="@routes.Assets.versioned("js/myzui.min.js")"></script>

    <style>
            .mysoft-content-left .form-group-extra .btn-sm {
                font-size: 14px;
                background-color: #27b9d0;
                border-color: #27b9d0;
                border-radius: 4px;
                padding: 5px 15px;
                height: auto;
            }
            .mysoft-content-right .tab-content, .mysoft-content-left form {
                box-shadow: unset;
            }
            .img-thumbnail {
                display: inline-block;
                max-width: 100%;
                height: auto;
                padding: 4px;
                line-height: 1.53846154;
                background-color: #fff;
                border: unset;
                border-radius: 4px;
                -webkit-transition: all .2s ease-in-out;
                -o-transition: all .2s ease-in-out;
                transition: all .2s ease-in-out;
            }
            blockquote {
                padding: 10px 20px;
                margin: 0 0 20px;
                 border-left: unset;
            }
    </style>

    <div class="col-md-12 mysoft-content">
        <div class="mysoft-content-left whitebox" style="width: 776px;">
            <form id="heatmap" method="GET" enctype="multipart/form-data" class="well form-inline" style="box-sizing: border-box!important;">
                <img class="tools-img" src="/assets/images/softpic/heatmap.png">
                <h3 class="tools-title">热图</h3>
                <div class="form-group">
                    <h2>
                    </h2>
                </div><br><br>
                <div class="form-group-p">
                    <div class="form-group">
                        <label for="mytaskname">任务编号：</label>
                    </div>
                    <div class="form-group">
                        <input id="mytaskname" type="text" class="form-control" name="taskname" placeholder="" value="heatmap">
                    </div>
                </div>

                <br><br>

                <script type="text/javascript">
                        $("#mytaskname").keyup(function () {
                            var val = $("#mytaskname").val();
                            var rule = /[()（）@@#$%^&*~`!|\/\\?;,.，。:"]/;
                            if (rule.test(val)) {
                                alert('任务编号里不能有特殊字符，请重新填写!');
                            }
                        })
                </script>
                <div id="div1" class="one-line">
                    <div class="form-group-p">
                        <div class="form-group">
                            <label for="exampleInputName2">上传矩阵表格文件：</label>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" id="filepath1" name="text1" readonly="readonly">
                            <img id="tempimg1" dynsrc="" src="" style="display:none">
                            <input id="hideinput1" type="file" name="table1" style="display:none;" onchange="change(this.value)">
                        </div>
                    </div>
                    <div class="form-group-extra">
                        <span id="choosefile" type="button" onclick="choosefile($(this))" data-id="1" class="btn btn-sm btn-info choosebutton">选择文件</span>
                        <span class="must">*</span>&nbsp;&nbsp;<em>
                        <a href="/tools/Public/help/heatmap.rpkm" target="_blank">
                            示例文件								</a>
                    </em>
                    </div>
                    <br>
                    <br>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading" data-toggle="collapse" href="#collapseOne">
                        <h4 class="panel-title">
                            <a id="pos1">
                                <span style="font-size:12px;">选填参数：</span>
                            </a>
                        </h4>
                    </div>
                    <div id="collapseOne" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="format">
                                        选择用于作图的列：</label>
                                </div>
                                <div class="form-group">
                                    <input id="min" type="text" name="colnum" placeholder="如2,3,4 或 2-4,6" class="form-control input-sm">
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group">
                                <label for="format">
                                    选择用于作图的行:(a、可以输入数字代表前多少行用于做图。b、输入一个基因名列表文件，用文件里的基因名对应行作图)										</label>
                            </div>
                            <br><br>
                            <div class="example">
                                <ul id="myTab" class="nav nav-tabs">
                                    <li class="">
                                        <a href="#tab1" data-toggle="tab">a、输入数字</a>
                                    </li>
                                    <li class="active">
                                        <a href="#tab2" data-toggle="tab">b、输入基因列表文件</a>
                                    </li>
                                </ul>
                                <br>
                                <div class="tab-content">
                                    <div class="tab-pane fade" id="tab1">
                                        <div class="form-group">
                                            <label>作图使用前</label>
                                            <input type="text" name="rownum" id="rownum" class="form-control input-sm" style="width:40px;">
                                            <label>行</label>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade active in" id="tab2">
                                        <div id="div2" class="one-line">
                                            <div class="form-group-p">
                                                <div class="form-group"><label for="exampleInputName2">或输入基因列表文件：</label></div><div class="form-group">
                                                <input type="text" class="form-control" id="filepath2" name="text2" readonly="readonly">
                                                <img id="tempimg2" dynsrc="" src="" style="display:none">
                                                <input id="hideinput2" type="file" name="table2" style="display:none;" onchange="change(this.value)">
                                            </div>
                                            </div>
                                            <div class="form-group-extra">
                                                <span id="choosefile" type="button" onclick="choosefile($(this))" data-id="2" class="btn btn-sm btn-info">选择文件</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>归一化：</label>
                                </div>
                                <div class="form-group">
                                    <select name="scale">
                                        <option value="row">row</option>
                                        <option value="column">column</option>
                                        <option value="none">none</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否对行聚类：</label>
                                </div>
                                <div class="form-group">
                                    <select name="cluster_rows">
                                        <option value="TRUE">yes</option>
                                        <option value="FALSE">no</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否对列聚类：</label>
                                </div>
                                <div class="form-group">
                                    <select name="cluster_cols">
                                        <option value="TRUE">yes</option>
                                        <option value="FALSE">no</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>

                            <div class="form-group">
                                <label>颜色：<span style="font-size:small;">&nbsp;(从左到右，代表数值越来越大)</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <select name="color" id="color" onchange="inputcolor()">
                                    <option value="0">green,black,red</option>
                                    <option value="1">navy,white,firebrick3</option>
                                    <option value="2">手动输入</option>
                                </select>
                            </div>
                            <br>

                            <div class="" style="display:none;margin-top: 20px;" id="mycolor">
                                <div class="form-group">
                                    <div style="width:90px;" class="evo-cp-wrap">
                                        <input id="color1" style="width:60px;" name="color1" value=" " class="colorPicker evo-cp0" readonly="readonly">

                                    </div>
                                </div>
                                    &nbsp;&nbsp;
                                <div class="form-group">
                                    <div style="width:90px;" class="evo-cp-wrap">
                                        <input id="color2" style="width:60px;" name="color2" value=" " class="colorPicker evo-cp1" readonly="readonly">
                                    </div>
                                </div>
                                    &nbsp;&nbsp;
                                <div class="form-group">
                                    <div style="width:90px;" class="evo-cp-wrap">
                                        <input id="color3" style="width:60px;" name="color3" value=" " class="colorPicker evo-cp2" readonly="readonly">
                                    </div>
                                </div>
                            </div>

                            <br>
                            <div class="form-group-p">

                                <div class="form-group">
                                    <label for="format">字体大小：</label>
                                </div>
                                <div class="form-group">
                                    <input id="fontsize" type="text" name="fontsize" value="10" class="form-control input-sm">
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>格子的长度 X 高度：</label><input type="text" name="width" id="width" placeholder="" class="form-control input-sm" style="width:40px;">
                                    X
                                    <input type="text" name="height" id="height" placeholder="" class="form-control input-sm" style="width:40px;">
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>在格子上显示数字：</label>
                                </div>
                                <div class="form-group">
                                    <select name="hasnum">
                                        <option value="FALSE">no</option>
                                        <option value="TRUE">yes</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>画出格子的边界：</label>
                                </div>
                                <div class="form-group">
                                    <select name="hasborder">
                                        <option value="FALSE">no</option>
                                        <option value="TRUE">yes</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>结果是否显示行名：</label>
                                </div>
                                <div class="form-group">
                                    <select name="hasrname">
                                        <option value="TRUE">yes</option>
                                        <option value="FALSE">no</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>结果是否显示列名：</label>
                                </div>
                                <div class="form-group">
                                    <select name="hascname">
                                        <option value="TRUE">yes</option>
                                        <option value="FALSE">no</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>
                        </div>
                    </div>
                </div>



                <input type="hidden" value="upload" name="act">
                <input type="hidden" value="heatmap" name="action">
                <input type="button" value="提&nbsp;&nbsp;交" name="submit" class="btn btn-primary" onclick="runheatmap()">
            </form>

        </div>

        <div class="handler"></div>
        <div class="mysoft-content-right" style="width: 279px;box-sizing: border-box!important;">
            <ul class="nav nav-tabs">

                <li class="active" id="out_tab1">
                    <a href="###" data-target="#example" data-toggle="tab">示例结果</a>
                </li>
                <li class="" id="ins_tab1">
                    <a href="###" data-target="#instruction" data-toggle="tab">使用说明</a>
                </li>
                <li style="display: none" id="result_tab1">
                    <a href="#" data-target="#result1" data-toggle="tab">运行结果</a>
                </li>

            </ul>
            <div class="tab-content" style="box-sizing: border-box!important;">

                <div class="tab-pane fade active in" id="example">
                    <h5>输出结果：heatmap热图</h5>
                    <img class="img-rounded img-thumbnail img-responsive" src="/assets/images/softpic/exampleResult/heatmap2.png" alt="生物云平台">
                </div>
                <div class="tab-pane fade" id="instruction">
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">功能：</span><br>
                        用一个带有表头的以tab分隔的表格数据绘制一个热图。
                    </p>
                    <br>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">输入：</span>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ① 矩阵文件:文件为二维矩阵文件，第一行一般为样本，第一列为基因名
                    </p>
                    <blockquote style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <pre>GeneID  JI2822Dp  JI2822Big JI2822Small JI2822Lp
                            Unigene0021981  1300.99832695328  1665.09778769998  1352.56038153151
                            Unigene0009129  3454.18444497397  355.800462393868  440.799944750064
                            Unigene0040921  1873.7233808357 551.402956075232  1529.66491348639
                            Unigene0034573  1567.1476372343 1073.13647863848  1053.63141860243
                            .     .     .       .
                        </pre>
                    </blockquote>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ② 列的参数:即选择用哪几列画图。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ③ 行的参数:可以数字输入前多少行作为绘图数据或输入基因名文件。
                    </p>
                    <span style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">上传文件格式说明：格式如下，数据与数据之间务必用制表符(tab符)隔开,可以选择在Excel中打开，然后另存为以tab键分隔的.txt文件。</span><br>
                    <img class="img-rounded img-thumbnail img-responsive" src="https://www.omicshare.com/tools/Public/help/heatmapfilein.png" alt="生物云平台" style="height:auto;"><span style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;"></span><br>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">参数：</span>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        可选输入
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ① 归一化（z-score）处理，选择列，或者行，或者不处理，一般选择行。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ② 颜色选择，一般选择green,black,red或者navy,white,firebrick3。也可以在调色板里选择任意颜色。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ③ 字体大小选择，默认为10px。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ④ 矩阵格子的长度和高度，默认为自适应，也可以设置为25X12。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ⑤ 是否在格子上显示数字，默认不显示。
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        ⑥ 是否在格子上显示边界，默认不显示。
                    </p>
                    <br>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        <span style="font-weight:700;">输出：</span>
                    </p>
                    <p style="color:#636E7B;font-family:Arial, 微软雅黑;font-size:14px;background-color:#FFFFFF;">
                        程序将按要求输出热图，提供PNG和PDF格式的文件下载
                    </p>
                    <p>
                        <br>
                    </p>						</div>
                <div class="tab-pane fade" id="result1">
                    <h5>结果列表：</h5>
                    <br>
                    <ul id="filesUrl" style="font-size: 1.2em;">
                    </ul>
                    <h5>结果预览：</h5>
                    <ul id="pics" style="font-size: 1.2em;">
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="@routes.Assets.versioned("js/toolsAdjust.js")"></script>
    <script type="text/javascript" src="@routes.Assets.versioned("palette/evol-colorpicker.min.js")"></script>
    <script type="text/javascript">


        function runheatmap() {
            if(@session.get("userId").isEmpty){
                swal({
                    title: "尚未登录",
                    text: "请先登录账号",
                    type: "warning",
                    confirmButtonText: "确认"
                })
            }else {

                var form1 = new FormData($("#heatmap")[0]);

                var element = "<div id='content'><span id='info'>运行中...</span>&nbsp;<img class='runningImage' src='/assets/images/loader-twitter.gif' style='width: 30px;height: 20px;'></div>"
                var index = layer.alert(element, {
                    skin: 'layui-layer-lan',
                    closeBtn: 0,
                    title: "Info",
                    btn: []
                });

                $.ajax({
                    url: "/CloudPlatform/SoftTool/runHeatmap?id=@session.get("userId")",
                    type: "post",
                    processData: false,
                    contentType: false,
                    data: form1,
                    success: function (data) {
                        if (data.valid === "false") {
                            layer.close(index);
                            swal("Error", data.message, "error");

                        } else {
                            layer.close(index);
                            $.ajax({
                                url:"/CloudPlatform/SoftTool/getFiles?id=@session.get("userId")"+"&taskname="+data.taskname,
                                type:"post",
                                success:function (pics) {
                                    var pic = "";
                                    var html = "";
                                    $.each(pics,function (i,v) {
                                        pic +="<li><img class='img-rounded img-thumbnail img-responsive' src='/CloudPlatform/pic?path="+v+"' alt=\"生物云平台\"><li>"
                                        html += "<li><a href='/CloudPlatform/SoftTool/download?path="+data.path+"&name=" + v.substring(v.lastIndexOf("\\")+1,v.length) + "' target='_blank'>" + v.substring(v.lastIndexOf("\\")+1,v.length) + "</a></li>"
                                    });
                                    $("#filesUrl").html(html);
                                    $("#pics").html(pic);
                                }
                            })

                            $("#result_tab1").show();
                            $("#result_tab1").addClass("active")
                            $("#out_tab1").removeClass("active")
                            $("#ins_tab1").removeClass("active")
                            $("#result1").addClass("active").addClass("in")
                            $("#example").removeClass("active");
                            $("#instruction").removeClass("active");
                        }
                    }
                });
            }

        }

            function choosefile($para) {
                if(@session.get("userId").isEmpty){
                    swal({
                        title: "尚未登录",
                        text: "请先登录账号",
                        type: "warning",
                        confirmButtonText: "确认"
                    })
                }else {
                    $number = $para.attr("data-id");
                    $("#hideinput" + $number).click();
                }

            }



            //上传文件判断，大小和格式 限制! 问题：云端文件判断不了。（云端文件上传时已经经过限制，可以大于5M，本地限制大小是因上传速度问题)
            var maxsize = 5 * 1024 * 1024;//2M
            var errMsg = '建议使用云端文件，本地文件上传最大为5M！';

            function change(value, rowMax, colMax) {
                $("#filepath" + $number).val(value);
                var filepath = document.getElementById("hideinput" + $number);

                var file_size = 0;


                file_size = filepath.files[0].size;
                let name = filepath.files[0].name;
                let patt = /^[a-zA-Z0-9._]+$/;
                if (!patt.test(name)) {
                    alert("文件名只能由字母，数字，'_'和'.'组成");
                    $("#filepath" + $number).val('');
                    $("#hideinput" + $number).val('');
                }
                var size = file_size;
                if (size > maxsize) {
                    alert(errMsg);
                    $("#filepath" + $number).val('');
                    $("#hideinput" + $number).val('');
                }

            }

            $('#color1').colorpicker({color: '#ff0000', showOn: 'button', defaultPalette: 'web'});
            $('#color2').colorpicker({color: '#92d050', showOn: 'button', defaultPalette: 'web'});
            $('#color3').colorpicker({color: '#000000', showOn: 'button', defaultPalette: 'web'});
            $(".colorPicker").attr("readonly", "readonly");

            function inputcolor() {
                var colorparam = $("#color").val();
                if (colorparam == 2) {
                    // $("#color").hide();
                    $("#mycolor").show();
                }
                else {
                    $("#mycolor").hide();
                }
            }
    </script>



}