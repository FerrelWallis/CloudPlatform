@import models.Tables.DutysRow
@(row:DutysRow)(implicit session: Session)
@home.main("Task Preview"){
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("font-awesome-4.7.0/css/font-awesome.min.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("bootstrap-fileinput-master/css/fileinput.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("palette/evol-colorpicker.min.css")" media="screen" />

    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("mycss/redraw.css")" media="screen" />

    <script type="text/javascript" src="@routes.Assets.versioned("js/jquery-ui.js")"></script>
    <script src="@routes.Assets.versioned("layer-v3.0/layer/layer.js")" type="text/javascript"></script>
    <script type="text/javascript" src="@routes.Assets.versioned("palette/evol-colorpicker.min.js")"></script>

    <div class="container" style="width: 98.5%;margin: unset;max-width: unset;padding: 5px">
        @task.preview(row,"Heatmap")
        <div class="mws-panel grid_8" style="background: white!important;">
            <div class="mws-panel-body" style="border: unset">
                <div class="mws-panel-content" style="width: 96%;padding-top: 0;padding-right: 0">
                    <hr>
                    <div class="redraw-head">
                        <h3 style="display: inline-block">重新绘图：</h3>
                        <div class="dropdown" style="display: inline-block">
                            <button class="btn btn-dark dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" style="padding: 7px 30px;text-shadow: unset;border-radius: 7px;">
                                下载结果图
                            </button>
                            <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(0px, 35px, 0px); top: 0px; left: 0px; will-change: transform;width: 150px">
                                <a class="dropdown-item" id="downPic">下载 pdf</a>
                                <a class="dropdown-item" id="downPng">下载 png</a>
                                <a class="dropdown-item" id="downTiff">下载 tiff</a>
                            </div>
                        </div>
                    </div>
                    <br>
                    <form id="Heatmap" style="display: none" method="GET" enctype="multipart/form-data">
                        <div style="width: 60%;float: left">
                            <img id="redraw_pic" src="" style="width: 100%;height: auto" >
                        </div>
                        <div class="redraw-right" style="width: 40%;float: left;margin-bottom: 30px;">
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="format">选择用于作图的列：</label>
                                    <input type="text" name="col" id="col" value="" placeholder="如1,2,3,4,5" class="form-control input-sm" style="width:200px;">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>归一化：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="scale" name="scale">
                                        <option value="column">column</option>
                                        <option value="row">row</option>
                                        <option value="none">none</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否取lg：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="lg" name="lg">
                                        <option value="none">none</option>
                                        <option value="lg2">lg2</option>
                                        <option value="lg10">lg10</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否对行聚类：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="cluster_rows" name="cluster_rows" onchange="showr()" style="width: 45%;">
                                        <option value="FALSE">no</option>
                                        <option value="TRUE">yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p" id="showrow" style="display: none">
                                <div class="form-group" style="margin-top: 5px;">
                                    <label for="">行聚类分割数(1-</label><label id="rnum"></label><label>)：</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="rp" name="rp" class="form-control" placeholder="数字" value="1" style="width: 50px;float: left;margin-right: 5px;margin-top: 5px">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否对列聚类：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="cluster_cols" name="cluster_cols" onchange="showc()" style="width: 45%;">
                                        <option value="FALSE">no</option>
                                        <option value="TRUE">yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p" id="showcol" style="display: none">
                                <div class="form-group" style="margin-top: 5px;">
                                    <label for="">列聚类分割数(1-</label><label id="cnum"></label><label>)：</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="cp" name="cp" class="form-control" placeholder="数字" value="1" style="width: 50px;float: left;margin-right: 5px;margin-top: 5px">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group" style="margin-top: 5px;">
                                    <label for="">行 X 列聚类树高度：</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="rtree" name="rtree" class="form-control" placeholder="数字" value="50" style="width: 50px;float: left;margin-right: 5px;margin-top: 5px">
                                    <label style="float: left;margin-top: 12px;">X</label>
                                    <input type="text" id="ctree" name="ctree" class="form-control" placeholder="数字" value="50" onblur="ylim();" style="width: 50px;  margin-left: 5px;float: left;margin-top: 5px;margin-right: 20px">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>颜色：<span style="font-size:small;">&nbsp;(数值从小到大)</span></label>
                                </div>
                                <div class="form-group" style="width: 150px;">
                                    <select name="color" id="color" onchange="show()" style="width: 100%;">
                                        <option value="#1E90FF:#FFFFFF:#E41A1C">蓝,白,红</option>
                                        <option value="black:red">黑-红</option>
                                        <option value="green:red:yellow">绿-红-黄</option>
                                        <option value="purple:black:yellow">紫-黑-黄</option>
                                        <option value="green:black:red">绿-黑-红</option>
                                        <option value="darkblue:darkgreen:yellow:darkred">深蓝-墨绿-黄-深红</option>
                                        <option value="0">手动输入</option>
                                    </select>
                                </div>
                            </div>
                            <div id="inputcolor" class="one-line" style="display: none">
                                <div style="border: 1px solid lightgrey;border-radius: 5px;padding: 10px;margin-left: 30px">
                                    <div class="form-group-p" style="padding-left: 0">
                                        <div style="width: 100%;margin-left: 10px">
                                            <label>自定义颜色（2-5个）：</label>
                                        </div>
                                    </div>
                                    <br><br>
                                    <div class="form-group-p" >
                                        <div class="form-group" style="width: 85%">
                                            <ul id="mycolor">

                                            </ul>
                                            <input type="text" id="designcolor" name="designcolor" class="form-control" value="" style="display: none">
                                        </div>
                                    </div>
                                    <div class="form-group-p" style="padding-left: 0">
                                        <input type="button" value="增加颜色" class="btn btn-primary btn-dark" onclick="addcolor()" style="width: 100px;">
                                        <input type="button" value="删除颜色" class="btn btn-primary btn-dark" onclick="delcolor()" style="width: 100px;">
                                    </div>

                                </div>
                                <br>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="">颜色渐变数量：</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="cc" name="cc" class="form-control" placeholder="数字" value="30" style="width: 50px;float: left;margin-right: 5px;">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group" style="margin-top: 5px;">
                                    <label for="">XY 轴字体大小：</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="xfs" name="xfs" class="form-control" placeholder="数字" value="10" style="width: 50px;float: left;margin-right: 5px;margin-top: 5px">
                                    <label style="float: left;margin-top: 12px;">：</label>
                                    <input type="text" id="yfs" name="yfs" class="form-control" placeholder="数字" value="10" style="width: 50px;  margin-left: 5px;float: left;margin-top: 5px;margin-right: 20px">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否画格子边界：</label>
                                </div>
                                <div class="form-group right">
                                    <select name="hasborder" style="width: 45%;" id="hasborder" onchange="bordercolor()">
                                        <option value="FALSE">no</option>
                                        <option value="TRUE">yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p" style="display:none;" id="borcolor">
                                <div class="form-group">
                                    <label>边界颜色</label>
                                </div>
                                <div class="form-group">
                                    <div  class="evo-cp-wrap">
                                        <input id="colorborder"  name="colorborder" value="" class="colorPicker evo-cp0" readonly="readonly">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>在格子上显示数字：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="hasnum" name="hasnum" style="width: 45%;">
                                        <option value="FALSE">no</option>
                                        <option value="TRUE">yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否显示行名：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="hasrname" name="hasrname" style="width: 45%;">
                                        <option value="TRUE">yes</option>
                                        <option value="FALSE">no</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>是否显示列名：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="hascname" name="hascname" style="width: 45%;">
                                        <option value="TRUE">yes</option>
                                        <option value="FALSE">no</option>
                                    </select>
                                </div>
                            </div>
                            <br>
                            <br>
                            <input type="button" value="绘&nbsp;&nbsp;制" name="submit" class="btn btn-primary btn-dark" onclick="DrawHeat()" style="margin-left: 30px">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="@routes.Assets.versioned("bootstrap-fileinput-master/js/fileinput.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("bootstrap-fileinput-master/js/locales/zh.js")" type="text/javascript"></script>

    <script>

        var colornum=0;

            function formValidation() {
                $('#Heatmap').formValidation({
                    framework: 'bootstrap',
                    icon: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        rtree: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        ctree: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        rp: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                },
                                greaterThan: {
                                    value: 1,
                                    message: "必须大于1！"
                                }
                            }
                        },
                        cp: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                },
                                greaterThan: {
                                    value: 1,
                                    message: "必须大于1！"
                                }
                            }
                        },
                        cc: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        xfs: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        yfs: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        }
                    }
                });
                $("#mailSigninForm").formValidation({
                    framework: 'bootstrap',
                    icon: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        phone: {
                            validators: {
                                notEmpty: {
                                    message: '请输入账号！'
                                }
                            }
                        },
                        code: {
                            validators: {
                                notEmpty: {
                                    message: '请输入验证码！'
                                }
                            }
                        }
                    }
                });
                $("#signinForm").formValidation({
                    framework: 'bootstrap',
                    icon: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        user: {
                            validators: {
                                notEmpty: {
                                    message: '请输入账号！'
                                }
                            }
                        },
                        password: {
                            validators: {
                                notEmpty: {
                                    message: '请输入密码！'
                                }
                            }
                        },
                        validnumber: {
                            validators: {
                                notEmpty: {
                                    message: '请输入验证码！'
                                },
                                callback: {
                                    message: '验证码错误！',
                                    callback: function () {
                                        return $('#validnumber').val() === code;
                                    }
                                }
                            }
                        }
                    }
                });
                $('#signupForm').formValidation({
                    framework: 'bootstrap',
                    icon: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        phone: {
                            validators: {
                                notEmpty: {
                                    message: '请输入手机号！'
                                },
                                phone:{
                                    message: '请输入正确手机号',
                                    country: 'CN'
                                }
                            }
                        },
                        name: {
                            validators: {
                                notEmpty: {
                                    message: '请填写姓名！'
                                }
                            }
                        },
                        email: {
                            validators: {
                                notEmpty: {
                                    message: '请填写邮箱地址！'
                                },
                                emailAddress:{
                                    message:'请输入正确邮箱地址！'
                                }
                            }
                        },
                        company: {
                            validators: {
                                notEmpty: {
                                    message: '请填写单位！'
                                }
                            }
                        },
                        password: {
                            validators: {
                                notEmpty: {
                                    message: '请输入密码！'
                                },
                                stringLength: {
                                    min: 6,
                                    message: '请输入至少六位密码！'
                                }
                            }
                        },
                        password1: {
                            validators: {
                                notEmpty: {
                                    message: '请输入确认密码！'
                                },
                                identical: {
                                    field: 'password',
                                    message: '两次密码不一致!'
                                }
                            }
                        },
                        validnumber: {
                            validators: {
                                notEmpty: {
                                    message: "请输入验证码！"
                                }
                            }
                        }
                    }
                });
                $('#passwordForm').formValidation({
                    framework: 'bootstrap',
                    icon: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        password1: {
                            validators: {
                                notEmpty: {
                                    message: '请输入新密码！'
                                },
                                stringLength: {
                                    min: 6,
                                    message: '请输入至少六位密码！'
                                }
                            }
                        },
                        password2: {
                            validators: {
                                notEmpty: {
                                    message: '请输入确认密码！'
                                },
                                identical: {
                                    field: 'password1',
                                    message: '两次密码不一致!'
                                }
                            }
                        },
                        validnumber: {
                            validators: {
                                notEmpty: {
                                    message: "请输入验证码！"
                                }
                            }
                        }
                    }
                });
            }

            $(document).ready(function () {
                if("@row.status"=="已完成"){
                    $("#Heatmap").show();
                    $.ajax({
                        url:"/CloudPlatform/SoftTool/getHeatData?taskname=@row.taskname",
                        type:"post",
                        success:function (data) {
                            $("#redraw_pic").attr("src","/CloudPlatform/pic?path="+data.pics[0]+"&num="+Math.random());
                            $("#downPic").attr("href","/CloudPlatform/SoftTool/download?path="+data.downpics);
                            $("#downPng").attr("href","/CloudPlatform/SoftTool/download?path="+data.downpng);
                            $("#downTiff").attr("href","/CloudPlatform/SoftTool/download?path="+data.downtiffs);
                            $("#rnum").text(data.rnum);
                            $("#cnum").text(data.cnum);
                            $.each(data.elements,function (i,v) {
                                if(i=="color") {
                                    if(colorpattern(v)) $("#"+i).val(v);
                                    else {
                                        $("#"+i).val("0");
                                        $("#inputcolor").show();
                                    }
                                    splitcolor(v);
                                } else $("#"+i).val(v);
                            });
                            bordercolor();
                            showr();
                            showc();
                        }
                    });
                }
            });

        $("#colorborder").colorpicker({color: '#000000', defaultPalette: 'web'});
        $(".colorPicker").attr("readonly", "readonly");
        $("#borcolor .evo-cp-wrap").css("float", "left");
        $("#borcolor .evo-cp-wrap").css("width", "120px");

            function splitcolor(param) {
                console.log("split="+param);
                var colo="";
                var colors=param.toString().split(":");
                colornum=colors.length;
                $.each(colors,function (i,v) {
                    colo +="<li><div class='evo-cp-wrap'><input id='color"+i+"'  name='color"+i+"' class='colorPicker evo-cp0' readonly='readonly'></div></li>";
                });
                $("#mycolor").html(colo);
                $.each(colors,function (i,v) {
                    $("#color"+i).colorpicker({color: v, defaultPalette: 'web'});
                });
                $(".colorPicker").attr("readonly", "readonly");
                $("#inputcolor .evo-cp-wrap").css("float", "left");
                $("#inputcolor .evo-cp-wrap").css("width", "200px");
            }

            function colorpattern(param) {
                var count = $('#color').find('option').length;
                for(var i=0;i<count;i++)
                {
                    if($('#color').get(0).options[i].value == param) return true;
                }
                return false;
            }

        function show() {
            var param = $("#color").val();
            if(param=="0") $("#inputcolor").show();
            else $("#inputcolor").hide();

        }

            function addcolor() {
                if(colornum==5){
                    swal({
                        title: "添加颜色失败",
                        text: "添加失败，颜色最大数量为5个！",
                        type: "warning",
                        confirmButtonText: "确认"
                    });
                }else{
                    var colo = "<li><div class='evo-cp-wrap'><input id='color"+colornum+"'  name='color"+colornum+"' class='colorPicker evo-cp0' readonly='readonly'></div></li>";
                    $("#mycolor").append(colo);
                    $("#color"+colornum).colorpicker({color: '#E41A1C', defaultPalette: 'web'});
                    $(".colorPicker").attr("readonly", "readonly");
                    $(".evo-cp-wrap").css("float", "left");
                    $(".evo-cp-wrap").css("width", "200px");
                    colornum=colornum+1;
                }

            }

            function delcolor() {
                if(colornum==2){
                    swal({
                        title: "删除颜色失败",
                        text: "删除失败，颜色最小数量为2个！",
                        type: "warning",
                        confirmButtonText: "确认"
                    });
                }else{
                    $("#color"+(colornum-1)).remove();
                    colornum=colornum-1;
                }
            }

            function DrawHeat() {
                var form = $("#Heatmap");
                var fv = form.data("formValidation");
                fv.validate();
                if (fv.isValid()) {
                    var element = "<div id='content'><span id='info'>绘图中，请耐心等待...</span>&nbsp;<img class='runningImage' src='/assets/images/loader-twitter.gif' style='width: 30px;height: 20px;float: right;padding-right: 11px;padding-top: 2px;'></div>"
                    var index = layer.alert(element, {
                        skin: 'layui-layer-lan',
                        closeBtn: 0,
                        title: "提醒",
                        btn: []
                    });
                    var colors=[];
                    for(var i=0;i<colornum;i++)
                        colors.push($("#color"+i).val());
                    $("#designcolor").val(colors.join(":"));
                    var form1 = new FormData($("#Heatmap")[0]);
                    $.ajax({
                        url: "/CloudPlatform/SoftTool/redrawHeat?taskname=@row.taskname",
                        type: "post",
                        processData: false,
                        contentType: false,
                        data: form1,
                        success: function (data) {
                            $("#redraw_pic").attr("src","/CloudPlatform/pic?path="+data.pics+"&num="+Math.random());
                            layer.close(index);
                        }
                    });
                }
            }


            function bordercolor() {
                var colorparam = $("#hasborder").val();
                if (colorparam == "TRUE") $("#borcolor").show();
                else $("#borcolor").hide();
            }

        function showr() {
            var colorparam = $("#cluster_rows").val();
            if (colorparam == "TRUE") $("#showrow").show();
            else $("#showrow").hide();
        }

        function showc() {
            var colorparam = $("#cluster_cols").val();
            if (colorparam == "TRUE") $("#showcol").show();
            else $("#showcol").hide();
        }
    </script>

}