@import models.Tables.DutysRow
@(row:DutysRow)(implicit session: Session)
@home.main("Task Preview"){
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("font-awesome-4.7.0/css/font-awesome.min.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("bootstrap-fileinput-master/css/fileinput.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("palette/evol-colorpicker.min.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("mycss/redraw.css")" media="screen" />

    <script type="text/javascript" src="@routes.Assets.versioned("js/jquery-ui.js")"></script>
    <script src="@routes.Assets.versioned("layer-v3.0/layer/layer.js")" type="text/javascript"></script>
    <script type="text/javascript" src="@routes.Assets.versioned("palette/evol-colorpicker.min.js")"></script>

    <div class="container" style="width: 98.5%;margin: unset;max-width: unset;padding: 5px">
        @task.preview(row,"PCA")
        <div class="mws-panel grid_8" style="background: white!important;">
            <div class="mws-panel-body" style="border: unset">
                <div class="mws-panel-content" style="width: 96%;padding-top: 0;padding-right: 0">
                    <hr>
                    <div class="redraw-head">
                        <h3 style="display: inline-block">重新绘图：</h3>
                        <div class="dropdown" style="display: inline-block">
                            <button class="btn btn-dark dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" style="padding: 7px 30px;text-shadow: unset;border-radius: 7px;">
                                下载结果图
                            </button>
                            <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(0px, 35px, 0px); top: 0px; left: 0px; will-change: transform;width: 150px">
                                <a class="dropdown-item" id="downPic">下载 pdf</a>
                                <a class="dropdown-item" id="downPng">下载 png</a>
                                <a class="dropdown-item" id="downTiff">下载 tiff</a>
                            </div>
                        </div>
                    </div>
                    <br>
                    <form id="PCA" style="display: none" method="GET" enctype="multipart/form-data">
                        <div style="width: 60%;float: left">
                            <img id="redraw_pic" src="/assets/images/.jpg" style="width: 100%;height: auto" >
                        </div>
                        <div class="redraw-right" style="width: 40%;float: left;margin-bottom: 30px;">
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="">选择x轴数据：</label><span class="must">&nbsp;&nbsp;*</span>
                                </div>
                                <div class="form-group right">
                                    <select name="xdata" id="xdata">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="">选择y轴数据：</label><span class="must">&nbsp;&nbsp;*</span>
                                </div>
                                <div class="form-group right">
                                    <select name="ydata" id="ydata">
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group ">
                                    <label>是否显示样本名：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="showname" name="showname" style="width: 40%;" onchange="shown()">
                                        <option value="FALSE">no</option>
                                        <option value="TRUE">yes</option>
                                    </select>
                                </div>
                                <div id="showerro" style="display: none">
                                    <div class="form-group ">
                                        <label>是否显示箭头：</label>
                                    </div>
                                    <div class="form-group right">
                                        <select name="showerro" style="width: 30%;">
                                            <option value="TRUE">yes</option>
                                            <option value="FALSE">no</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="one-line" >
                                <div style="border: 1px solid lightgrey;border-radius: 5px;padding: 10px;margin-left: 30px">
                                    <div class="form-group-p" style="padding-left: 0">
                                        <div style="width: 100%;margin-top: 10px">
                                            <label>自定义颜色(当前分组 - 颜色)：</label>
                                            <span id="groupname"></span>
                                        </div>
                                    </div>
                                    <br><br>
                                    <div class="form-group-p" >
                                        <div class="form-group" style="width: 85%">
                                            <ul id="mycolor">
                                            </ul>
                                            <input type="text" id="color" name="color" class="form-control" value="" style="display: none">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="">图片长宽：</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="width" name="width" class="form-control" placeholder="数字" value="15" style="width: 50px;float: left;margin-right: 5px">
                                    <label style="float: left">--</label>
                                    <input type="text" id="length" name="length" class="form-control" placeholder="数字" value="12" style="width: 50px;  margin-left: 5px;float: left">
                                </div>
                            </div>
                            <br>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label>清晰度：</label>
                                </div>
                                <div class="form-group right">
                                    <select id="resolution" name="resolution">
                                        <option value="300">300</option>
                                        <option value="600">600</option>
                                        <option value="96">96</option>
                                        <option value="72">72</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="">x轴字体大小：</label>
                                </div>
                                <div class="form-group" style="width: 70px;margin-right: 40px">
                                    <input type="text" id="xts" name="xts" class="form-control" placeholder="数字" value="15" style="width: 100%;float: left;">
                                </div>
                                <div class="form-group">
                                    <label for="">y轴字体大小：</label>
                                </div>
                                <div class="form-group" style="width: 70px">
                                    <input type="text" id="yts" name="yts" class="form-control" placeholder="数字" value="15" style="width: 100%;float: left;">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="">x轴标题大小：</label>
                                </div>
                                <div class="form-group" style="width: 70px;margin-right: 40px">
                                    <input type="text" id="xls" name="xls" class="form-control" placeholder="数字" value="17" style="width: 100%;float: left;">
                                </div>
                                <div class="form-group">
                                    <label for="">y轴标题大小：</label>
                                </div>
                                <div class="form-group" style="width: 70px">
                                    <input type="text" id="yls" name="yls" class="form-control" placeholder="数字" value="17" style="width: 100%;float: left;">
                                </div>
                            </div>
                            <div class="form-group-p">
                                <div class="form-group">
                                    <label for="">说明文字大小：</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="lts" name="lts" class="form-control" placeholder="数字" value="14" style="width: 36%;float: left;margin-right: 5px">
                                </div>
                            </div>
                            <br>
                            <br>
                            <input type="button" value="绘&nbsp;&nbsp;制" name="submit" class="btn btn-primary btn-dark" onclick="DrawPCA()" style="margin-left: 30px">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="@routes.Assets.versioned("bootstrap-fileinput-master/js/fileinput.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("bootstrap-fileinput-master/js/locales/zh.js")" type="text/javascript"></script>

    <script>

            function formValidation() {
                $('#PCA').formValidation({
                    framework: 'bootstrap',
                    icon: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        width: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        length: {
                            notEmpty: {
                                message: '不能为空!'
                            },
                            validators: {
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        xts: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        yts: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        xls: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        yls: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        lts: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        }
                    }
                });
            }

            var colornum=0;
            var color,group;

            $(document).ready(function () {
                if("@row.status"=="已完成"){
                    $("#PCA").show();
                    $.ajax({
                        url:"/CloudPlatform/SoftTool/getPCAData?taskname=@row.taskname",
                        type:"post",
                        success:function (data) {
                            $("#redraw_pic").attr("src","/CloudPlatform/pic?path="+data.pics[0]+"&num="+Math.random());
                            $("#downPic").attr("href","/CloudPlatform/SoftTool/download?path="+data.downpics);
                            $("#downPng").attr("href","/CloudPlatform/SoftTool/download?path="+data.downpng);
                            $("#downTiff").attr("href","/CloudPlatform/SoftTool/download?path="+data.downtiffs);
                            var cols="";
                            $.each(data.cols,function (i,v) {
                                cols +="<option value='"+v+"'>"+v+"</option>";
                            });
                            $("#xdata").html(cols);
                            $("#ydata").html(cols);

                            $.each(data.elements,function (i,v) {
                                $("#"+i).val(v);
                            });
                            shown();
                            colornum=data.group.length;
                            var colo="";
                            $.each(data.group,function (i,v) {
                                colo +="<li><div style='float: left;width: 30%;margin-top: 5px;'><label>"+v+"</label></div><div class='evo-cp-wrap'><input id='color"+i+"'  name='color"+i+"' class='colorPicker evo-cp0' readonly='readonly'></div></li>";
                            });
                            $("#mycolor").html(colo);
                            $.each(data.group,function (i,v) {
                                $("#color"+i).colorpicker({color: data.color[i], defaultPalette: 'web'});
                            });
                            $(".colorPicker").attr("readonly", "readonly");
                            $(".evo-cp-wrap").css("float", "left");
                            $(".evo-cp-wrap").css("width", "180px");
                        }
                    });
                }
            });

            function DrawPCA() {
                var form = $("#PCA");
                var fv = form.data("formValidation");
                fv.validate();
                if (fv.isValid()) {
                    if(checkXYCol()){
                        swal({
                            title: "请检查xy轴数据",
                            text: "x轴数据与y轴数据不可为同一个！",
                            type: "warning",
                            confirmButtonText: "确认"
                        });
                        return;
                    }
                    var element = "<div id='content'><span id='info'>绘图中，请耐心等待...</span>&nbsp;<img class='runningImage' src='/assets/images/loader-twitter.gif' style='width: 30px;height: 20px;float: right;padding-right: 11px;padding-top: 2px;'></div>";
                    var index = layer.alert(element, {
                        skin: 'layui-layer-lan',
                        closeBtn: 0,
                        title: "提醒",
                        btn: []
                    });
                    var c=[];
                    for(let i=0;i<colornum;i++){
                        c.push($("#color"+i).val());
                    }
                    $("#color").val(c.join(":"));
                    var form1 = new FormData($("#PCA")[0]);
                    $.ajax({
                        url: "/CloudPlatform/SoftTool/redrawPCA?taskname=@row.taskname",
                        type: "post",
                        processData: false,
                        contentType: false,
                        data: form1,
                        success: function (data) {
                            $("#redraw_pic").attr("src","/CloudPlatform/pic?path="+data.pics+"&num="+Math.random());
                            layer.close(index);
                        }
                    });
                }
            }


            function checkXYCol(){
                if($("#xdata").val()===$("#ydata").val()) return true;
                else return false;
            }

            function shown() {
                var param = $("#showname").val();
                if (param == "TRUE") $("#showerro").show();
                else $("#showerro").hide();
            }


    </script>
}