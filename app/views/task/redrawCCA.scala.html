@import models.Tables.DutysRow
@(row:DutysRow)(implicit session: Session)
@home.main("Task Preview"){
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("bootstrap-slider-master/css/bootstrap-slider.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("font-awesome-4.7.0/css/font-awesome.min.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("bootstrap-fileinput-master/css/fileinput.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("palette/evol-colorpicker.min.css")" media="screen" />
    <link rel="stylesheet" type="text/css" href="@routes.Assets.versioned("mycss/redraw.css")" media="screen" />

    <script type="text/javascript" src="@routes.Assets.versioned("js/jquery-ui.js")"></script>
    <script src="@routes.Assets.versioned("layer-v3.0/layer/layer.js")" type="text/javascript"></script>
    <script type="text/javascript" src="@routes.Assets.versioned("palette/evol-colorpicker.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.versioned("bootstrap-slider-master/bootstrap-slider.js")"></script>


    <style>
            .picleft{
                margin-top: 5px;
                width: 120px;
                text-align: right;
            }
            .picright{
                width: 200px;
            }
            .fontleft{
                margin-top: 5px;
                width: 130px;
                text-align: right;
            }
            .fontright{
                width: 190px;
            }
            .picright select{
                width: 100%;
            }
            .fontright select{
                width: 100%;
            }
    </style>

    <div class="container" style="width: 98.5%;margin: unset;max-width: unset;padding: 5px">
        @task.preview(row)
        <div class="mws-panel grid_8" style="background: white!important;">
            <div class="mws-panel-body" style="border: unset">
                <div class="mws-panel-content" style="width: 96%;padding-top: 0;padding-right: 0">
                    <hr>
                    <div class="redraw-head">
                        <h3 style="display: inline-block">重新绘图：</h3>
                        <div class="dropdown" style="display: inline-block">
                            <button class="btn btn-dark dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" style="padding: 7px 30px;text-shadow: unset;border-radius: 7px;">
                                下载结果图
                            </button>
                            <div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; transform: translate3d(0px, 35px, 0px); top: 0px; left: 0px; will-change: transform;width: 150px">
                                <a class="dropdown-item" id="downPic" onclick="downloadpics('rdacca','pdf')">下载 pdf</a>
                                <a class="dropdown-item" id="downPng" onclick="downloadpics('rdacca','png')">下载 png</a>
                                <a class="dropdown-item" id="downTiff" onclick="downloadpics('rdacca','tiff')">下载 tiff</a>
                            </div>
                        </div>
                    </div>
                    <br>
                    <form id="CCA" style="display: none" method="GET" enctype="multipart/form-data">
                        <div style="width: 60%;float: left">
                            <img id="redraw_pic" src="/assets/images/.jpg" style="width: 100%;height: auto" >
                        </div>
                        <div class="redraw_panel redraw-right" style="width: 40%;float: left;margin-bottom: 30px;">
                            <ul class="nav nav-tabs" style="margin-left: 20px">
                                <li class="active" id="ins_tab1" >
                                    <a href="###" data-target="#picpara" data-toggle="tab">数据布局参数</a>
                                </li>
                                <li class="" id="col_tab1" >
                                    <a href="###" data-target="#colopara" data-toggle="tab">颜色参数</a>
                                </li>
                                <li class="" id="out_tab1">
                                    <a href="###" data-target="#fontpara" data-toggle="tab">字体参数</a>
                                </li>
                            </ul>

                            <div class="tab-content" style="box-sizing: border-box!important;padding-top: 30px">
                                <div class="tab-pane fade active in" id="picpara">
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label for="">选择x轴数据：</label>
                                        </div>
                                        <div class="form-group right picright">
                                            <select name="xdata" id="xdata">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label for="">选择y轴数据：</label>
                                        </div>
                                        <div class="form-group right picright">
                                            <select name="ydata" id="ydata">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label for="">原点坐标(X : Y)：</label>
                                        </div>
                                        <div class="form-group picright" style="margin-left: 10px">
                                            <input type="text" id="xaxis" name="xaxis" class="form-control" placeholder="数字" value="0" style="width: 50px;float: left;margin-right: 5px">
                                            <label style="float: left"> : </label>
                                            <input type="text" id="yaxis" name="yaxis" class="form-control" placeholder="数字" value="0" style="width: 50px;  margin-left: 5px;float: left">
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label>样品点大小：</label>
                                        </div>
                                        <div class="form-group picright">
                                            <input type="text" id="samsize" name="samsize" class="form-control" placeholder="数字" value="6" style="width: 65px;float: left;margin-right: 5px;margin-left: 10px;">
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label>是否显示样品名：</label>
                                        </div>
                                        <div class="form-group right picright">
                                            <select id="showsname" name="showsname" onchange="sample()" >
                                                <option value="false">no</option>
                                                <option value="true">yes</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label>是否显示环境因子：</label>
                                        </div>
                                        <div class="form-group right picright">
                                            <select id="showevi" name="showevi" onchange="evi()">
                                                <option value="false">no</option>
                                                <option value="true">yes</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label>是否显示物种：</label>
                                        </div>
                                        <div class="form-group right picright">
                                            <select id="showspeci" name="showspeci" onchange="speci()">
                                                <option value="false">no</option>
                                                <option value="true">yes</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group-p" id="specispart" style="display: none">
                                        <div class="form-group picleft">
                                            <label>物种点大小：</label>
                                        </div>
                                        <div class="form-group picright" style="margin-left: 10px">
                                            <input type="text" id="specisize" name="specisize" class="form-control" placeholder="数字" value="6" style="width: 70px;float: left;margin-right: 5px">
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label>清晰度：</label>
                                        </div>
                                        <div class="form-group picright">
                                            <select id="dpi" name="dpi">
                                                <option value="300">300</option>
                                                <option value="600">600</option>
                                                <option value="96">96</option>
                                                <option value="72">72</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group picleft">
                                            <label for="">图片长宽：</label>
                                        </div>
                                        <div class="form-group picright" style="margin-left: 10px">
                                            <input type="text" id="width" name="width" class="form-control" placeholder="数字" value="15" style="width: 50px;float: left;margin-right: 5px">
                                            <label style="float: left">--</label>
                                            <input type="text" id="height" name="height" class="form-control" placeholder="数字" value="15" style="width: 50px;  margin-left: 5px;float: left">
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="colopara">

                                        <div style="border: 1px solid lightgrey;border-radius: 5px;padding: 10px;margin-left: 30px">
                                            <div class="form-group-p" style="width: 100%;padding-left: 0">
                                                <div class="form-group" >
                                                    <label for="color">
                                                        样品点颜色(分组 - 颜色)：
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="form-group-p" >
                                                <div class="form-group" style="width: 85%">
                                                    <ul id="mycolor">
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                    <br>
                                    <div style="display: none">
                                        <input type="text" id="color" name="color" >
                                    </div>

                                    <div id="evicpart" style="display: none">
                                        <div class="form-group-p">
                                            <div id="snamecolor">
                                                <div class="form-group">
                                                    <label>环境因子名颜色：</label>
                                                </div>
                                                <div class="form-group" style="width: 60%">
                                                    <div  class="evo-cp-wrap" style="margin-right: 10px">
                                                        <input id="color1"  name="color1" value=" " class="colorPicker evo-cp0">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group-p">
                                            <div id="snamecolor">
                                                <div class="form-group">
                                                    <label>环境因子坐标线颜色：</label>
                                                </div>
                                                <div class="form-group" style="width: 60%">
                                                    <div  class="evo-cp-wrap" style="margin-right: 10px">
                                                        <input id="color2"  name="color2" value=" " class="colorPicker evo-cp0">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="specicpart" style="display: none">
                                        <div class="form-group-p">
                                            <div id="snamecolor">
                                                <div class="form-group">
                                                    <label>物种颜色：</label>
                                                </div>
                                                <div class="form-group">
                                                    <div  class="evo-cp-wrap">
                                                        <input id="color3"  name="color3" value=" " class="colorPicker evo-cp0" style="margin-top: -5px;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="fontpara">
                                    <div class="form-group-p" id="sample" style="display: none">
                                        <div class="form-group fontleft">
                                            <label>样品名字体大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                          <input id="samfont" name="samfont" data-slider-id='ssamfont' type="text" data-slider-min="0" data-slider-max="15" data-slider-step="1" data-slider-value="7"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p" id="evifpart" style="display: none">
                                        <div class="form-group fontleft">
                                            <label>环境因子字体大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="evifont" name="evifont" data-slider-id='sevifont' type="text" data-slider-min="0" data-slider-max="15" data-slider-step="1" data-slider-value="7"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p" id="specifpart" style="display: none">
                                        <div class="form-group fontleft">
                                            <label>物种名字体大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="specifont" name="specifont" data-slider-id='sspecifont' type="text" data-slider-min="0" data-slider-max="15" data-slider-step="1" data-slider-value="7"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group fontleft">
                                            <label for="">x轴字体大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="xts" name="xts" data-slider-id='sxts' type="text" data-slider-min="0" data-slider-max="50" data-slider-step="1" data-slider-value="16"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group fontleft">
                                            <label for="">x轴标题大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="xls" name="xls" data-slider-id='sxls' type="text" data-slider-min="0" data-slider-max="50" data-slider-step="1" data-slider-value="18"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group fontleft">
                                            <label for="">y轴字体大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="yts" name="yts" data-slider-id='syts' type="text" data-slider-min="0" data-slider-max="50" data-slider-step="1" data-slider-value="16"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group fontleft">
                                            <label for="">y轴标题大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="yls" name="yls" data-slider-id='syls' type="text" data-slider-min="0" data-slider-max="50" data-slider-step="1" data-slider-value="18"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group fontleft" style="margin-top: 5px;">
                                            <label for="">说明字体大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="lts" name="lts" data-slider-id='slts' type="text" data-slider-min="0" data-slider-max="50" data-slider-step="1" data-slider-value="15"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group fontleft" style="margin-top: 5px;">
                                            <label for="">说明标题大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="lms" name="lms" data-slider-id='slms' type="text" data-slider-min="0" data-slider-max="50" data-slider-step="1" data-slider-value="15"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p">
                                        <div class="form-group fontleft" style="margin-top: 5px;">
                                            <label for="">主标题大小：</label>
                                        </div>
                                        <div class="form-group fontright" style="line-height: 39px;">
                                            <input id="ms" name="ms" data-slider-id='sms' type="text" data-slider-min="0" data-slider-max="50" data-slider-step="1" data-slider-value="15"/>
                                        </div>
                                    </div>
                                    <div class="form-group-p" id="ytextpart">
                                        <div class="form-group fontleft" style="margin-top: 5px;">
                                            <label for="">主标题：</label>
                                        </div>
                                        <div class="form-group fontright">
                                            <input type="text" id="mstext" name="mstext" class="form-control" placeholder="标题不可含有汉字" value="" style="margin-left: 10px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <input type="button" value="绘&nbsp;&nbsp;制" name="submit" class="btn btn-primary btn-dark" onclick="DrawCCA()" style="margin-left: 30px">
                        </div>
                        <div class="update_panel redraw-right" style="width: 40%;float: left;margin-bottom: 30px;">
                            <div style="padding: 20px">
                                <h3 style="color: red">通知：</h3>
                                <span style="color: red">软件版本已在<label class="update"></label>更新！<label class="update"></label> 前运行的 @row.sname 任务仅可下载结果文件，不支持重新绘图。</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="@routes.Assets.versioned("bootstrap-fileinput-master/js/fileinput.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("bootstrap-fileinput-master/js/locales/zh.js")" type="text/javascript"></script>

    <script>

            const updatetime="2020-07-29";

            function checkupdate(){
                $(".update").text(updatetime);
                if("@row.subtime".split(" ")[0]<=updatetime) {
                    $(".update_panel").show();
                    $(".redraw_panel").hide();
                } else {
                    $(".redraw_panel").show();
                    $(".update_panel").hide();
                }
            }

            function downloadpics(picname,suffix){
                if("@row.status"!=="已完成"){
                    swal({
                        title: "无法下载",
                        text: "任务未完成，无法下载！",
                        type: "warning",
                        confirmButtonText: "确认"
                    });
                }else{
                    window.location.href = "/CloudPlatform/SoftTool/download?taskname=@row.taskname&picname="+picname+"&suffix="+suffix+"&num="+Math.random();
                }
            }

            const colorValidators = {
                validators: {
                    notEmpty:{
                        message: '不能为空!'
                    },
                    regexp: {
                        regexp: /^#([0-9a-fA-F]{6})$/,
                        message: "色值不合法！色值必须以#开头，色值需为6位"
                    }
                }
            };

            function formValidation() {
                $('#CCA').formValidation({
                    framework: 'bootstrap',
                    icon: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    excluded: [':disabled'],
                    fields: {
                        xaxis: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        yaxis: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        samsize: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        specisize: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        width: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        height: {
                            validators: {
                                notEmpty: {
                                    message: '不能为空!'
                                },
                                numeric: {
                                    message: '必须为数字！'
                                }
                            }
                        },
                        mstext:{
                            validators:{
                                callback:{
                                    message: '标题不能有汉字!',
                                    callback: function (value, validator, $field) {
                                        return chechtitle("mstext");
                                    }
                                }
                            }
                        },
                        color1:colorValidators,
                        color2:colorValidators,
                        color3:colorValidators
                    }
                });
            }

            function chechtitle(param){
                var val = $("#"+param).val();
                var rule = /[\u4e00-\u9fa5]+/;
                return !(rule.test(val));
            }

            var colornum=0;

            $(document).ready(function () {
                if("@row.status"=="已完成"){
                    $("#CCA").show();
                    $.ajax({
                        url:"/CloudPlatform/SoftTool/getCCAData?taskname=@row.taskname",
                        type:"post",
                        success:function (data) {
                            $("#redraw_pic").attr("src","/CloudPlatform/pic?path="+data.pics[0]+"&num="+Math.random());
                            $("#groupname").text(data.group);
                            colornum=data.group.toString().trim().split(",").length;
                            var cols="";
                            $.each(data.cols,function (i,v) {
                                cols +="<option value='"+v+"'>"+v+"</option>";
                            });
                            $("#xdata").html(cols);
                            $("#ydata").html(cols);
                            $.each(data.elements,function (i,v) {
                                if(i.indexOf("color")>=0){
                                    $("#"+i).colorpicker({color: v, defaultPalette: 'web',showOn: "button"})
                                            .on("change.color",function (event,color){
                                                $("#CCA").formValidation("revalidateField",i);
                                            });
                                } else {
                                    if($("#"+i).attr("data-slider-id")==null) $("#"+i).val(v);
                                    else {
                                        $("#"+i).bootstrapSlider({tooltip:'always'});
                                        $("#" + i).bootstrapSlider('setValue', v);
                                    }
                                }
                            });
                            sample();
                            evi();
                            speci();
                            colornum=data.group.length;
                            var colo="";
                            $.each(data.group,function (i,v) {
                                colo +="<li class='form-group' style='width: 100%'><div style='float: left;width: 30%;margin-top: 5px;'><label>"+v+"</label></div><div class='evo-cp-wrap'><input id='color"+(4+i)+"'  name='color"+(4+i)+"' class='colorPicker evo-cp0'></div></li>";
                            });
                            $("#mycolor").html(colo);
                            $.each(data.group,function (i,v) {
                                //给动态生成的元素进行验证
                                $("#CCA").formValidation('addField','color'+(4+i), colorValidators);
                                $("#color"+(4+i)).colorpicker({color: data.color[i], defaultPalette: 'web',showOn: "button"})
                                        .on("change.color", function(event, color){ //选择颜色事件
                                            //formValidation重新验证颜色
                                            $("#CCA").formValidation("revalidateField", "color"+(4+i));
                                        });
                            });

                            // $(".colorPicker").attr("readonly", "readonly");
                            $(".evo-cp-wrap").css("float", "left");
                            $("#mycolor .evo-cp-wrap").css("width", "70%");
                            $("#snamecolor .evo-cp-wrap").css("width", "95px");
                            checkupdate();
                        }
                    });
                }
            });


            $("#snamecolor .evo-cp-wrap").css("width", "95px");

            function DrawCCA() {
                var form = $("#CCA");
                var fv = form.data("formValidation");
                fv.validate();
                if (fv.isValid()) {
                    if(checkXYCol()){
                        swal({
                            title: "请检查xy轴数据",
                            text: "x轴数据与y轴数据不可为同一个！",
                            type: "warning",
                            confirmButtonText: "确认"
                        });
                        return;
                    }
                    var element = "<div id='content'><span id='info'>绘图中，请耐心等待...</span>&nbsp;<img class='runningImage' src='/assets/images/loader-twitter.gif' style='width: 30px;height: 20px;float: right;padding-right: 11px;padding-top: 2px;'></div>"
                    var index = layer.alert(element, {
                        skin: 'layui-layer-lan',
                        closeBtn: 0,
                        title: "提醒",
                        btn: []
                    });
                    var c=[];
                    for(let i=0;i<colornum;i++){
                        c.push($("#color"+(4+i)).val());
                    }
                    $("#color").val(c.join(":"));
                    var form1 = new FormData($("#CCA")[0]);
                    $.ajax({
                        url: "/CloudPlatform/SoftTool/redrawCCA?taskname=@row.taskname&showsname="+$("#showsname").val()+"&showevi="+$("#showevi").val()+"&showspeci="+$("#showspeci").val(),
                        type: "post",
                        processData: false,
                        contentType: false,
                        data: form1,
                        success: function (data) {
                            $("#redraw_pic").attr("src","/CloudPlatform/pic?path="+data.pics+"&num="+Math.random());
                            layer.close(index);
                        }
                    });
                }else {
                    switchToInvalid();
                    swal({
                        title: "参数设置错误",
                        text: "有参数不合法，请核实！",
                        type: "error",
                        confirmButtonText: "确认"
                    });
                }
            }

            //找第一个invalid元素，并跳转
            function switchToInvalid() {
                $(".help-block[data-fv-result='INVALID']").each(function () {
                    if($(this).parent().parent().attr('id')){
                        if($(this).parent().parent().attr('id').toString().indexOf("color")>=0){
                            $("a[data-target='#colopara']").click();
                        }else{
                            var parent=$(this).parent().parent().parent().attr('id');
                            $("a[data-target='#"+parent+"']").click();
                        }
                    } else{
                        var parent=$(this).parent().parent().parent().attr('id');
                        $("a[data-target='#"+parent+"']").click();
                    }
                    return false;
                });
            }

            function checkXYCol(){
                if($("#xdata").val()===$("#ydata").val()) return true;
                else return false;
            }

            function sample() {
                var param = $("#showsname").val();
                if (param == "true") $("#sample").show();
                else $("#sample").hide();
            }

            function evi() {
                var param = $("#showevi").val();
                if (param == "true") {
                    $("#evicpart").show();
                    $("#evifpart").show();
                } else {
                    $("#evicpart").hide();
                    $("#evifpart").hide();
                }
            }

            function speci() {
                var param = $("#showspeci").val();
                if (param == "true") {
                    $("#specifpart").show();
                    $("#specicpart").show();
                    $("#specispart").show();
                } else {
                    $("#specifpart").hide();
                    $("#specicpart").hide();
                    $("#specispart").hide();
                }
            }

    </script>


}